#!/usr/bin/env bash
# katifetch_bsd.sh - Complete BSD edition of Katifetch
# Works on FreeBSD, OpenBSD, NetBSD, DragonFly, Unknown BSD

# ------------------ Auto wrapper ------------------
if [ -z "$BASH_VERSION" ]; then
    exec bash "$0" "$@"
fi

# ------------------ Logos ------------------
logo_freebsd="
\033[31m                @@@@@@   @%########%    @@@@@@   \033[37m
\033[31m               @%%#-.-=%+..    ......#%::.=#%@   \033[37m
\033[31m                @%%#*=...........:*#....-=%%*@   \033[37m
\033[31m                @@%#...............= ..-#%%+@    \033[37m
\033[31m                 @#.......::::::::::*=*#%%=@@    \033[37m
\033[31m                @@:.:...:---****####*=#%#:+:@    \033[37m
\033[31m                @..=: .-+*#######%%%%%%#*#*=+@   \033[37m
\033[31m                @.+=--=*########%%%%%%%%%%%+:@   \033[37m
\033[31m               @@:#*****######%%%%%%%%%%%%%+.@   \033[37m
\033[31m                @.%##****####%%%%%#%%%%%%%%.:@   \033[37m
\033[31m                @-#####***###%%%#%%%%%%%%%..#@   \033[37m
\033[31m                 @ %#####**##%%%%%%%%%%%*=.-@    \033[37m
\033[31m                @@.%#######*#*##%%#++***--@      \033[37m
\033[31m                  @=#%#######*******++--#@       \033[37m
\033[31m                   @@=*%%#####******--*@@        \033[37m
\033[31m                     @@@#=*++*=----#@@           \033[37m
\033[31m                         @@@@@@@@@@              \033[37m
"

logo_openbsd="
\033[33m                                      %              \033[37m
\033[33m                          %#     %    %    +         \033[37m
\033[33m                       @%  %%  % -% %% % % #:     %  \033[37m
\033[33m                        +% # -%%%#:       * % %  *   \033[37m
\033[33m                  %   # % %*       %          :% = @%\033[37m
\033[33m                   %%  %+# #  -                   ##%\033[37m
\033[33m               %:%  %         #-     +-       %   * %%%   %%\033[37m
\033[33m                 % %%  :        #           #      %  %% %\033[37m
\033[33m           #%    %%-     =         =    =:             +%\033[37m
\033[33m             #      %         *                #    *   %\033[37m
\033[33m             %%#        .                :        *  %   %\033[37m
\033[33m           %       =%-   *                               : %\033[37m
\033[33m            %  #%%   #                          -#         %%\033[37m
\033[33m   *%#@   %*  %:                                 %     % = %\033[37m
\033[33m%#%:    %    %    #   *                             % #  %  +\033[37m
\033[33m    %.    #*#%                                       =  #  : #\033[37m
\033[33m     %+       * +=               -               =   : -    % %\033[37m
\033[33m       %           :                                 %=*%  #  %%\033[37m
\033[33m        *      +  *    =    %                       #         % %\033[37m
\033[33m        %+   #% % -        %     #                    #      =   =%%\033[37m
\033[33m         %     = % :     %                -           :%   .# %%%@\033[37m
\033[33m         % %*  %%+   %       -                     %      *%\033[37m
\033[33m        %     %  %        .       -#           %   --   %%%\033[37m
\033[33m                % +  %  : =                  .    .    %@%\033[37m
\033[33m                #%  % :                               #%\033[37m
\033[33m               %    +# %          =              %  %  *%#\033[37m
\033[33m                   @%   =*%%.:       # %         -%%=\033[37m
\033[33m                        .%   @%%:  % *    : %=%+%   @%\033[37m
\033[33m                       %#  %%  # %  .*@+ % %*  %%\033[37m
\033[33m                                =%  %  @    +    %\033[37m
\033[33m                                %       %         \033[37m
"

logo_netbsd="
\033[31m                                        ++             \033[37m
\033[31m                               ++++++++++              \033[37m
\033[31m          + ++++       ++++++++++++                    \033[37m
\033[31m           + ++++++++++++++++++++++++++++              \033[37m
\033[31m            + ++++++++++++++++++++++                   \033[37m
\033[31m             + +++++++++++++++++                       \033[37m
\033[31m              + ++++++++++++                           \033[37m
\033[31m               +                                       \033[37m
\033[31m               ++                                      \033[37m
\033[31m++++    ++++    ++     ++++++++    +++++ ++++++++   +++\033[37m
\033[31m  +++     +             +++   ++  ++   +  ++     ++++ +\033[37m
\033[31m  + +++   +   ++  +++   +++  +++  ++++    ++      +++  \033[37m
\033[31m  +   +++ +++  ++ +++   +++  +++    ++++  ++      +++  \033[37m
\033[31m  +    ++++++     +++   +++   ++++    +++ ++     +++   \033[37m
\033[31m ++      ++ +++++ +++   +++  +++ ++   ++  +++   +++    \033[37m
\033[31m                       ++                              \033[37m
\033[31m                        ++                             \033[37m
\033[31m                         ++                            \033[37m
\033[31m                         +++                           \033[37m
\033[31m                          +++                          \033[37m
\033[31m                           +++                         \033[37m
\033[31m                            ++                         \033[37m
"

logo_dfly="
\033[31m        .*@@@@@@@@%=                    \033[37m
\033[31m     ..        :@@#----:::---=@@%.      \033[37m
\033[31m    @ .:*@#. :@%--::::::@::::::-=@@ .*@*\033[37m
\033[31m    +#     .=@%-::::::@%@#@::::::*@*.   \033[37m
\033[31m     :@.       .#@=::=*@%@%-::%@:       \033[37m
\033[31m       =@-         +@+@%@@*@#.        -@\033[37m
\033[31m         .@@%=:.      =@@*.     .:+@@@@.\033[37m
\033[31m       ..:@=--::-++##@@%%%@#++=-:::--*@.\033[37m
\033[31m  .@@*-:              .%%.              :-*@@.\033[37m
\033[31m  +*.              .%@@###@%.               #*\033[37m
\033[31m    =@#..    ..+@@+:::%%#@:::+@@+..    ..*@= \033[37m
\033[31m         ..@%-::::::::%##@:::::::::=@*.      \033[37m
\033[31m            @@-:::::::%##@:::::::-=@*        \033[37m
\033[31m             -@#--::::%@@@:::::--@@.         \033[37m
\033[31m               -@@*---%##@:---%@@.           \033[37m
\033[31m                  :#@@@%%@@@@*.              \033[37m
\033[31m                      =@%#                   \033[37m
\033[31m                      =%%+                   \033[37m
\033[31m                      =@@+                   \033[37m
\033[31m                      :%%:                   \033[37m
\033[31m                      :%@:                   \033[37m
\033[31m                      :@@.                   \033[37m
\033[31m                      .@@                    \033[37m
\033[31m                      .@@                    \033[37m
\033[31m                      .@%                    \033[37m
\033[31m                      .@#.                   \033[37m
\033[31m                      .@=                    \033[37m
"

logo_unknown="
\033[2;31m  %%%%%%%%%       %%%%%%%%      %%%%%%%%       \033[0m
\033[2;31m %%%     %%%%   %%%%    %%%%   %%%     %%%%    \033[0m
\033[2;31m%%         %%   %%             %%         %%%  \033[0m
\033[2;31m%%         %%% %%%             %%           %% \033[0m
\033[2;31m%%        %%%   %%%%           %%            %%\033[0m
\033[2;31m%%%%%%%%%%%%%     %%%%%        %%            %%\033[0m
\033[2;31m%%         %%%%      %%%%%%    %%            %%\033[0m
\033[2;31m%%           %%%         %%%%  %%            %%\033[0m
\033[2;31m%%            %%           %%  %%           %% \033[0m
\033[2;31m%%           %%%          %%%  %%         %%%  \033[0m
\033[2;31m%%         %%%% %%%%%    %%%   %%%     %%%%    \033[0m
\033[2;31m%%%%%%%%%%%%%     %%%%%%%%%    %%%%%%%%%       \033[0m
"

# ------------------ Functions ------------------
exists() { command -v "$1" >/dev/null 2>&1; }

get_distro() {
    if [ -r /etc/os-release ]; then
        . /etc/os-release
        [ -n "$PRETTY_NAME" ] && printf "%s" "$PRETTY_NAME" && return
    fi
    uname -s
}

detect_vm() {
    vm="no"
    if exists sysctl; then
        sysctl -n hw.model 2>/dev/null | grep -Ei "virtualbox|vmware|kvm|qemu|hyper-v|bhyve" >/dev/null 2>&1 && vm="yes"
    fi
    [ "$vm" = "no" ] && exists dmesg && dmesg | grep -Ei "virtualbox|vmware|kvm|qemu|hyper-v|bhyve|parallels" >/dev/null 2>&1 && vm="yes"
    printf "%s" "$vm"
}

# ------------------ Gather info ------------------
HOST=$(hostname)
OS=$(get_distro)
KERNEL=$(uname -sr)
UP=$(uptime | sed 's/,.*//')
CPU_MODEL=$(sysctl -n hw.model 2>/dev/null || sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "Unknown")
CPU_COUNT=$(sysctl -n hw.ncpu 2>/dev/null || echo "1")
MEM=$(awk "BEGIN {printf \"%d MiB\", $(sysctl -n hw.physmem 2>/dev/null || echo 0)/1024/1024}")
DISK=$(df -h / | awk 'NR==2 {print $3 " / " $2 " (used)"}')
PKG=$(exists pkg && echo "pkg" || echo "unknown")
DE=${XDG_CURRENT_DESKTOP:-${DESKTOP_SESSION:-terminal}}
VM=$(detect_vm)

INFO=$(cat <<EOF
Host: $HOST
OS: $OS
Kernel: $KERNEL
Uptime: $UP
CPU: $CPU_MODEL ($CPU_COUNT cores)
Memory: $MEM
Disk: $DISK
Packages: $PKG
Session: $DE
VM: $VM
EOF
)

# ------------------ Choose logo ------------------
case "$(uname -s)" in
    FreeBSD) LOGO="$logo_freebsd" ;;
    OpenBSD) LOGO="$logo_openbsd" ;;
    NetBSD) LOGO="$logo_netbsd" ;;
    DragonFly) LOGO="$logo_dfly" ;;
    *) LOGO="$logo_unknown" ;;
esac

# ------------------ Print side by side ------------------
print_side_by_side() {
    local logo_lines info_lines max i
    IFS=$'\n' read -rd '' -a logo_lines <<< "$1"
    IFS=$'\n' read -rd '' -a info_lines <<< "$2"
    max=${#logo_lines[@]}
    [ ${#info_lines[@]} -gt $max ] && max=${#info_lines[@]}
    for ((i=0;i<max;i++)); do
        # %b interpreta los colores
        printf "%-45b %b\n" "${logo_lines[i]:-}" "${info_lines[i]:-}"
    done
}

# ------------------ Run ------------------
print_side_by_side "$LOGO" "$INFO"

exit 0
